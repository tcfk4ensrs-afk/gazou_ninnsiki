<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIã‚¹ãƒãƒƒãƒˆåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f4f4f4; color: #333; }
        #webcam-container { margin: 20px auto; width: 300px; height: 300px; border: 5px solid #fff; border-radius: 15px; overflow: hidden; background: #000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: relative; }
        #webcam-container canvas { width: 100% !important; height: auto !important; }
        
        .controls { margin-top: 20px; display: flex; justify-content: center; gap: 10px; flex-direction: column; align-items: center; }
        button { padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; border: none; border-radius: 50px; transition: 0.3s; width: 80%; max-width: 300px; }
        
        .btn-start { background: #007bff; color: white; }
        .btn-capture { background: #e91e63; color: white; display: none; }
        .btn-reset { background: #6c757d; color: white; display: none; }
        
        .info-card { display: none; margin: 20px auto; padding: 20px; background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; }
        #status { margin: 15px; font-size: 14px; color: #666; min-height: 1.5em; }
        .result-label { font-size: 24px; font-weight: bold; color: #e91e63; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h1>AIã‚¹ãƒãƒƒãƒˆåˆ¤å®š</h1>
    
    <div id="status">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
    
    <div id="webcam-container"></div>

    <div class="controls">
        <button id="start-btn" class="btn-start" onclick="initSystem()">ã‚·ã‚¹ãƒ†ãƒ ã‚’èµ·å‹•</button>
        <button id="capture-btn" class="btn-capture" onclick="captureAndPredict()">ğŸ“¸ å†™çœŸã‚’æ’®ã£ã¦åˆ¤å®š</button>
        <button id="reset-btn" class="btn-reset" onclick="resetSystem()">ã‚‚ã†ä¸€åº¦æ’®ã‚‹</button>
    </div>
    
    <div id="info-area" class="info-card">
        <div id="result-label" class="result-label"></div>
        <div id="info-desc"></div>
        <p id="distance-info" style="font-size: 0.9em; color: #28a745; margin-top: 10px;"></p>
    </div>

    <script>
        const TARGETS = {
            "Nintendo": { lat: 35.6586, lon: 139.7454, title: "ä»»å¤©å ‚ã‚¹ãƒãƒƒãƒˆ", desc: "ã“ã“ã«ç‰¹åˆ¥ãªä»»å¤©å ‚æƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚" },
            "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³": { lat: 35.6812, lon: 139.7671, title: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³", desc: "ã‚»ãƒ–ãƒ³ã‚¤ãƒ¬ãƒ–ãƒ³ä»˜è¿‘ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚" }
            //"Nintendo": { 
        //lat: 35.6586, 
       //lon: 139.7454, 
        //title: "ä»»å¤©å ‚ã‚¹ãƒãƒƒãƒˆ", 
        //desc: "ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ç‰¹åˆ¥ãªå£ç´™ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã—ã¾ã™ã€‚",
        //image: "nintendo-bonus.jpg" // â† ã“ã“ã«ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¿½åŠ //
    }
        };

        let model, webcam, maxPredictions;
        let isPaused = false;
        let userLat, userLon;

        // ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸèª­ã¿è¾¼ã¿
        async function loadModel() {
            try {
                const URL = "./";
                model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                maxPredictions = model.getTotalClasses();
                document.getElementById("status").innerText = "æº–å‚™å®Œäº†ï¼èµ·å‹•ã—ã¦ãã ã•ã„ã€‚";
            } catch (e) {
                document.getElementById("status").innerText = "ã‚¨ãƒ©ãƒ¼: ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
            }
        }

        // ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ï¼ˆã‚«ãƒ¡ãƒ©ã¨GPSï¼‰
        async function initSystem() {
            document.getElementById("status").innerText = "ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...";
            
            navigator.geolocation.getCurrentPosition(async (pos) => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;

                // ã‚«ãƒ¡ãƒ©è¨­å®š
                webcam = new tmImage.Webcam(300, 300, false); // facingModeã¯setupã§æŒ‡å®š
                await webcam.setup({ facingMode: "environment" }); 
                await webcam.play();
                
                document.getElementById("webcam-container").innerHTML = "";
                document.getElementById("webcam-container").appendChild(webcam.canvas);
                
                document.getElementById("start-btn").style.display = "none";
                document.getElementById("capture-btn").style.display = "block";
                document.getElementById("status").innerText = "ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚";
                
                isPaused = false;
                window.requestAnimationFrame(loop);
            }, (err) => {
                alert("ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™");
                document.getElementById("status").innerText = "ä½ç½®æƒ…å ±ã‚¨ãƒ©ãƒ¼ã€‚";
            });
        }

        // ãƒ«ãƒ¼ãƒ—ï¼ˆæ˜ åƒã®æ›´æ–°ã®ã¿ï¼‰
        async function loop() {
            if (!isPaused) {
                webcam.update();
                window.requestAnimationFrame(loop);
            }
        }

        // ã€ä»Šå›ã®ãƒ¡ã‚¤ãƒ³ã€‘å†™çœŸã‚’æ’®ã£ã¦åˆ¤å®š
        async function captureAndPredict() {
            isPaused = true; // ãƒ«ãƒ¼ãƒ—ã‚’æ­¢ã‚ã‚‹ï¼ˆãƒ•ãƒªãƒ¼ã‚ºï¼‰
            document.getElementById("status").innerText = "åˆ¤å®šä¸­...";
            document.getElementById("capture-btn").style.display = "none";

            // AIåˆ¤å®š
            const prediction = await model.predict(webcam.canvas);
            
            // ä¸€ç•ªç¢ºç‡ãŒé«˜ã„çµæœã‚’å–å¾—
            let topPrediction = prediction.reduce((prev, current) => 
                (prev.probability > current.probability) ? prev : current
            );

            // èƒŒæ™¯ã‚¯ãƒ©ã‚¹ã€ã¾ãŸã¯ç¢ºç‡ãŒä½ã„å ´åˆ
            if (topPrediction.className === "èƒŒæ™¯" || topPrediction.probability < 0.8) {
                document.getElementById("status").innerText = "ä½•ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
                document.getElementById("reset-btn").style.display = "block";
                return;
            }

            const className = topPrediction.className;
            const target = TARGETS[className];

            if (target) {
                const dist = calculateDistance(userLat, userLon, target.lat, target.lon);
                
                if (dist <= 50) {
                    showResult(target, dist);
                    document.getElementById("status").innerText = "åˆ¤å®šæˆåŠŸï¼";
                } else {
                    document.getElementById("status").innerText = "å¯¾è±¡ã¯åˆã£ã¦ã„ã¾ã™ãŒã€å ´æ‰€ãŒé ã™ãã¾ã™ã€‚";
                    document.getElementById("distance-info").innerText = `(ç¾åœ¨åœ°ã‹ã‚‰ç´„ ${Math.round(dist)}m)`;
                    document.getElementById("info-area").style.display = "block";
                    document.getElementById("result-label").innerText = className;
                    document.getElementById("info-desc").innerText = "ã‚‚ã£ã¨è¿‘ãã§æ’®å½±ã—ã¦ãã ã•ã„ã€‚";
                }
            }
            
            document.getElementById("reset-btn").style.display = "block";
        }

        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function resetSystem() {
            isPaused = false;
            document.getElementById("info-area").style.display = "none";
            document.getElementById("reset-btn").style.display = "none";
            document.getElementById("capture-btn").style.display = "block";
            document.getElementById("status").innerText = "ã‚¹ã‚­ãƒ£ãƒ³ã‚’å†é–‹ã—ã¾ã—ãŸã€‚";
            window.requestAnimationFrame(loop);
        }

        function showResult(target, dist) {
            const area = document.getElementById("info-area");
            area.style.display = "block";
            document.getElementById("result-label").innerText = target.title;
            document.getElementById("info-desc").innerText = target.desc;
            document.getElementById("distance-info").innerText = `âœ… ä½ç½®ç¢ºèªæ¸ˆã¿ (è·é›¢: ${Math.round(dist)}m)`;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        }

        loadModel();
    </script>
</body>
</html>
